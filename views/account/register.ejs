<!DOCTYPE html>

<html>
<head>
    <title><%=pageTitle%></title>
    <%- include('../includes/bootstrapSetup.ejs') %>
    <%- include('../includes/bootstrap-dialog.ejs') %>
    <link href="/css/register.css" rel="stylesheet">
    <script src="/js/account/register.js"></script>
</head>

<body>
    <%- include('../includes/navbar.ejs') %>

    <div class="main-content-frame">
      <h3><%=pageData.account.accountName%></h3>
      <div>
        <select class="input-width-medium" id="accountShortcut">
          <% pageData.accountList.forEach(function(val, idx, arr) { %>
            <option value="<%=val.id%>"
              <%-(val.accountCode === pageData.account.accountCode ? "selected" : "")  + ">" + val.accountCode + "</option>" %>
          <% }); %>
        </select>
      </div>


      <button class="btn btn-success btn-register" id="btnAddNewTxn" data-accid="<%=pageData.account.id%>" accesskey="n">Add a new Transaction</button>

      <table class="table table-striped">
        <thead class="thead-inverse">
          <tr>
            <td>Date</td>
            <td>Payee</td>
            <td class="conditional-field-wide">Category</td>
            <td class="field-format-currency conditional-field-wide">Amount Dr</td>
            <td class="field-format-currency conditional-field-wide">Amount Cr</td>
            <td class="field-format-currency conditional-field-narrow">Amount Cr/Dr</td>
            <td class="field-format-currency">Balance</td>
          </tr>
        </thead>
        <tbody>
          <% var previousDate = '', foundDateLine = false; %>
          <% pageData.transactionList.forEach(function(val, idx, arr) { %>

            <%
              var prefix, suffix, isTransfer = (val.payee.transferAccount && val.payee.transferAccount.code);
              if (isTransfer) {
                prefix = (val.amount >= 0) ? "FROM>> " : "TO>> ";
                suffix = (val.amount < 0) ? "" : "";
              }

              var futureDateClass = '',
                  dateLineClass = '',
                  today = new Date(),
                  transDate = new Date(val.transactionDate);

              if (!foundDateLine && val.transactionDate !== previousDate && transDate < today) {
                dateLineClass = 'register-date-line';
                foundDateLine = true;
              } else {
                dateLineClass = '';
                futureDateClass = (transDate > today) ? 'register-future-date' : '';
              }

            %>

            <tr class="<%=dateLineClass%> <%=(val.isCleared) ? '': 'uncleared' %>" data-txid="<%=val.id%>"
                                           data-cleared="<%=val.isCleared%>"
                                           data-placeholder="<%=val.isPlaceholder%>"
                                           data-futuredate="<%=(transDate > today) ? 'true' : 'false'%>">

              <td><%=val.transactionDate%></td>
              <td><%=(isTransfer) ? prefix + val.payee.transferAccount.code + suffix : val.payee.name%></td>
              <td class="conditional-field-wide"><%=val.category.name%></td>
              <td class="field-format-currency conditional-field-wide"><a class="field-format-dr" href="/account/<%=pageData.account.id%>/transaction/<%=val.id%>"><%=(val.amount < 0 ? parseFloat(val.amount).toFixed(2) : "")%></a></td>
              <td class="field-format-currency conditional-field-wide"><a class="field-format-cr" href="/account/<%=pageData.account.id%>/transaction/<%=val.id%>"><%=(val.amount >= 0 ? parseFloat(val.amount).toFixed(2) : "")%></a></td>
              <td class="field-format-currency conditional-field-narrow"><a class="<%=(val.amount < 0 ? 'field-format-dr' : 'field-format-cr');%>" href="/account/<%=pageData.account.id%>/transaction/<%=val.id%>"><%=parseFloat(val.amount).toFixed(2)%></a></td>
              <td class="field-format-currency"><a href="/account/<%=pageData.account.id%>/transaction/<%=val.id%>"><%=val.balance%></a></td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <!-- <pre><%=JSON.stringify(pageData);%></pre> -->

    </div>
</body>
</html>
